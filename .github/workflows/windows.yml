name: windows

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install PostgreSQL
        run: choco install -y postgresql

      - name: Start PostgreSQL service
        run: net start postgresql-x64-15

      - name: Setup PostgreSQL user and database
        shell: pwsh
        run: |
          $env:PGPASSWORD = 'my_password'
          $psql = 'C:\Program Files\PostgreSQL\15\bin\psql.exe'
          & $psql -U postgres -c "CREATE USER my_user WITH PASSWORD 'my_password';"
          & $psql -U postgres -c "CREATE DATABASE my_db OWNER my_user;"

      - name: Wait for PostgreSQL to be ready
        shell: pwsh
        run: |
          $env:PGPASSWORD = 'my_password'
          $psql = 'C:\Program Files\PostgreSQL\15\bin\psql.exe'
          while ($true) {
            try {
              & $psql -U my_user -d my_db -c "SELECT 1;" | Out-Null
              break
            } catch {
              Write-Host "Waiting for PostgreSQL..."
              Start-Sleep -Seconds 2
            }
          }

      - name: Create table in the database
        run: |
          set PGPASSWORD=my_password
          "C:\Program Files\PostgreSQL\15\bin\psql.exe" -U my_user -d my_db -c "CREATE TABLE my_table (id SERIAL PRIMARY KEY, description TEXT);"

      - name: Build the project
        run: |
          git clone https://github.com/leventkaragol/libcpp-pg-pool.git C:\libcpp-pg-pool
          cd C:\libcpp-pg-pool
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake
          cmake --build build --config Release

      - name: Run tests
        run: |
          cd C:\libcpp-pg-pool
          .\build\test\Release\test.exe
